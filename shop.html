<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заказы | AFC - Auxiliary Forces Company</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Teko:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased selection:bg-green-700 selection:text-white">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-[#0a0b09]/90 backdrop-blur-md border-b border-[#3f4d36]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="index.html" class="flex-shrink-0 flex items-center gap-3">
                    <img src="logo.png" alt="AFC Logo" class="h-12 w-auto">
                    <span class="font-bold text-2xl tracking-wider text-gray-100 hidden sm:block font-teko">AFC CLAN</span>
                </a>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="index.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Главная</a>
                        <a href="info.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">О нас</a>
                        <a href="veli.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">VELI</a>
                        <a href="media.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Медиа</a>
                        <a href="work.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Деятельность</a>
                        <a href="shop.html" class="nav-active text-white px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Заказы</a>
                        <a href="join.html" class="bg-[#3f4d36] hover:bg-[#2d3826] text-white px-4 py-1 text-lg font-teko tracking-wide transition-all border border-[#658451] uppercase">Вступить</a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-btn" class="text-gray-400 hover:text-white focus:outline-none p-2">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu -->
        <div class="hidden md:hidden bg-black/95 border-b border-green-900" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 text-center">
                <a href="index.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">Главная</a>
                <a href="info.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">О нас</a>
                <a href="veli.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">VELI</a>
                <a href="media.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">Медиа</a>
                <a href="work.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">Деятельность</a>
                <a href="shop.html" class="text-[#658451] block px-3 py-2 text-xl font-teko uppercase">Заказы</a>
                <a href="join.html" class="text-white block px-3 py-2 text-xl font-teko uppercase font-bold">Вступить</a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header pt-20" style="background-image: url('stroi.png');">
        <div class="absolute inset-0 page-header-overlay"></div>
        <div class="relative z-10 text-center px-4 py-20">
            <h1 class="text-5xl md:text-7xl font-bold text-white mb-4 font-teko">ЗАКАЗЫ <span class="text-[#658451]">AFC</span></h1>
            <p class="text-xl text-gray-400">Система заявок и личный кабинет</p>
        </div>
    </section>

    <section class="py-24 bg-[#0a0b09] fade-in-section">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="tactical-border p-8 bg-[#121410] mb-12" id="auth-panel">
                <div class="flex flex-col lg:flex-row gap-10 items-center">
                    <div class="text-center lg:text-left flex-1">
                        <h2 class="text-3xl text-white font-teko mb-3">ДОСТУП В СИСТЕМУ</h2>
                        <p class="text-gray-500">Введите ник и пароль, чтобы создавать заявки и общаться с админами.</p>
                        <p class="text-gray-500 text-sm mt-4">Логин создается по нику. Админы подтверждают заявки и ведут переписку.</p>
                    </div>
                    <div class="flex-1 w-full">
                        <div class="flex gap-3 mb-4">
                            <button id="tab-login" class="px-4 py-2 bg-[#3f4d36] text-white font-teko uppercase tracking-wider">Вход</button>
                            <button id="tab-register" class="px-4 py-2 border border-[#3f4d36] text-gray-300 font-teko uppercase tracking-wider">Регистрация</button>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <input type="text" id="login-nick" placeholder="Ник" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <input type="password" id="login-password" placeholder="Пароль" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <button type="submit" class="w-full bg-[#658451] hover:bg-[#4d663d] text-white px-6 py-3 font-teko text-xl uppercase tracking-wider transition-all">Войти</button>
                        </form>
                        <form id="register-form" class="space-y-4 hidden">
                            <input type="text" id="register-nick" placeholder="Ник" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <input type="password" id="register-password" placeholder="Пароль" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <button type="submit" class="w-full bg-[#3f4d36] hover:bg-[#2d3826] text-white px-6 py-3 font-teko text-xl uppercase tracking-wider transition-all">Создать аккаунт</button>
                        </form>
                        <p id="auth-error" class="mt-4 text-sm text-red-300 hidden"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-[1.2fr_0.8fr] gap-10 order-layout hidden" id="dashboard">
                <div class="tactical-border p-8 bg-[#121410] order-panel panel-glow">
                    <div class="flex items-center justify-between flex-wrap gap-4 mb-8">
                        <div>
                            <h2 class="text-3xl text-white font-teko">ЦЕНТР ЗАКАЗОВ</h2>
                            <p class="text-gray-500 text-sm" id="cooldown-hint">Можно создавать несколько тикетов. Между отправками — 10 секунд.</p>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-400" id="user-status">
                            <span class="pulse-dot"></span>
                            Оффлайн
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="stat-chip">
                            <span class="text-xs uppercase tracking-widest text-gray-500">Активные</span>
                            <span class="stat-value" id="stat-active">0</span>
                        </div>
                        <div class="stat-chip">
                            <span class="text-xs uppercase tracking-widest text-gray-500">В работе</span>
                            <span class="stat-value" id="stat-progress">0</span>
                        </div>
                        <div class="stat-chip">
                            <span class="text-xs uppercase tracking-widest text-gray-500">Выполнено</span>
                            <span class="stat-value" id="stat-done">0</span>
                        </div>
                    </div>

                    <form id="ticket-form" class="space-y-5">
                        <div>
                            <label class="text-gray-400 text-sm uppercase tracking-widest">Заголовок</label>
                            <input type="text" id="ticket-subject" class="w-full mt-2 bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Например: Снабжение передовой" required>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm uppercase tracking-widest">Описание</label>
                            <textarea id="ticket-description" rows="5" class="w-full mt-2 bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Опишите задачу, сроки и требования" required></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-gray-400 text-sm uppercase tracking-widest">Приоритет</label>
                                <select id="ticket-priority" class="w-full mt-2 bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]">
                                    <option value="Обычный">Обычный</option>
                                    <option value="Высокий">Высокий</option>
                                    <option value="Критический">Критический</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-gray-400 text-sm uppercase tracking-widest">Контакт</label>
                                <input type="text" id="ticket-contact" class="w-full mt-2 bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Discord / Steam / Nick" required>
                            </div>
                        </div>
                        <button type="submit" id="ticket-submit" class="w-full bg-[#658451] hover:bg-[#4d663d] text-white px-6 py-3 font-teko text-2xl uppercase tracking-wider transition-all border border-transparent hover:border-[#8da378] shadow-[0_0_15px_rgba(101,132,81,0.3)]">
                            Отправить тикет
                        </button>
                    </form>

                    <div class="mt-10 tactical-border p-6 bg-[#0f110e] panel-glow">
                        <h3 class="text-2xl text-white font-teko mb-2">ЧАТ ПО ТИКЕТУ</h3>
                        <p class="text-gray-500 text-sm">Откройте тикет в списке справа — переписка появится в модальном окне.</p>
                    </div>
                </div>

                <div class="space-y-6 order-sidebar">
                    <div class="tactical-border p-6 bg-[#121410]">
                        <h3 class="text-2xl text-white font-teko mb-4">ПРОФИЛЬ</h3>
                        <div class="space-y-3 text-gray-400 text-sm">
                            <p><span class="text-[#658451]">Ник:</span> <span id="user-nick">—</span></p>
                            <p><span class="text-[#658451]">Роль:</span> <span id="user-role">Боец</span></p>
                        </div>
                        <button id="logout-btn" class="mt-6 w-full bg-[#3f4d36] hover:bg-[#2d3826] text-white px-4 py-2 font-teko uppercase tracking-wider transition-all">Выйти</button>
                    </div>

                    <div class="tactical-border p-6 bg-[#121410] panel-glow">
                        <h3 class="text-2xl text-white font-teko mb-4">МОИ ТИКЕТЫ</h3>
                        <div id="user-tickets" class="space-y-4 text-gray-400 text-sm">
                            <p>Пока нет активных заявок.</p>
                        </div>
                    </div>

                    <div class="tactical-border p-6 bg-[#121410] hidden panel-glow" id="admin-panel">
                        <h3 class="text-2xl text-white font-teko mb-4">ПАНЕЛЬ АДМИНА</h3>
                        <p class="text-gray-500 text-sm mb-4">Доступна только администраторам. Управляйте статусом тикетов и отвечайте в чате.</p>
                        <div class="flex flex-wrap gap-3 text-xs text-gray-500 uppercase tracking-widest mb-4">
                            <span class="px-3 py-1 border border-[#3f4d36]">Live Sync</span>
                            <span class="px-3 py-1 border border-[#3f4d36]">Realtime Database</span>
                        </div>
                        <div id="admin-tickets" class="space-y-4 text-gray-400 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="chat-modal" class="fixed inset-0 z-[1100] hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-[#0f110e] border border-[#3f4d36] w-[95%] max-w-2xl max-h-[85vh] flex flex-col shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-[#1a1d18]">
                <div>
                    <h3 class="text-2xl text-white font-teko">Чат по тикету</h3>
                    <p class="text-xs uppercase tracking-widest text-gray-500">Тикет: <span id="chat-ticket-title" class="text-[#658451]"></span></p>
                </div>
                <button id="chat-modal-close" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 overflow-y-auto flex-1" id="chat-messages"></div>
            <div class="p-5 border-t border-[#1a1d18] space-y-3">
                <textarea id="chat-input" rows="3" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Сообщение..."></textarea>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                    <input type="file" id="chat-file" accept="image/*" class="text-sm text-gray-400">
                    <button id="chat-send" class="ml-auto bg-[#3f4d36] hover:bg-[#2d3826] text-white px-5 py-2 font-teko uppercase tracking-wider transition-all">Отправить</button>
                </div>
                <p class="text-xs text-gray-500">Фото прикрепляются как изображение в чате (до 1 МБ).</p>
            </div>
        </div>
    </div>

    <footer class="bg-[#050505] py-10 border-t border-[#1a1d18]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="Logo" class="h-8 w-auto grayscale opacity-50">
                <span class="text-gray-500 font-teko text-xl tracking-widest">&copy; 2026 AFC CLAN | сайт создан @ssbaxys</span>
            </div>
            <div class="flex space-x-8">
                <a href="https://discord.com/invite/join-afc" class="text-gray-500 hover:text-[#5865F2] transition-colors">
                    <i class="fab fa-discord text-2xl"></i>
                </a>
                <a href="https://www.youtube.com/@wanted2127/videos" class="text-gray-500 hover:text-red-600 transition-colors">
                    <i class="fab fa-youtube text-2xl"></i>
                </a>
            </div>
        </div>
    </footer>

    <script src="app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, push, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBRBCKD_86JsJ_x9TRubfSbN4mbj_VIcxI",
          authDomain: "ssbaxys-2945e.firebaseapp.com",
          databaseURL: "https://ssbaxys-2945e-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "ssbaxys-2945e",
          storageBucket: "ssbaxys-2945e.firebasestorage.app",
          messagingSenderId: "952293073742",
          appId: "1:952293073742:web:a66570635496c7a323f41f",
          measurementId: "G-SXZENL1KY8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const authPanel = document.getElementById('auth-panel');
        const dashboard = document.getElementById('dashboard');
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authErrorEl = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');

        const userNickEl = document.getElementById('user-nick');
        const userRoleEl = document.getElementById('user-role');
        const userStatusEl = document.getElementById('user-status');
        const adminPanel = document.getElementById('admin-panel');
        const userTicketsEl = document.getElementById('user-tickets');
        const adminTickets = document.getElementById('admin-tickets');

        const chatModal = document.getElementById('chat-modal');
        const chatModalClose = document.getElementById('chat-modal-close');
        const chatTicketTitle = document.getElementById('chat-ticket-title');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatFile = document.getElementById('chat-file');
        const chatSend = document.getElementById('chat-send');

        const ticketForm = document.getElementById('ticket-form');
        const ticketSubmit = document.getElementById('ticket-submit');

        let activeTicketId = null;
        let activeTicketOwner = null;
        let cooldown = false;

        const showError = (message) => {
            authErrorEl.textContent = message;
            authErrorEl.classList.remove('hidden');
        };

        const hideError = () => {
            authErrorEl.textContent = '';
            authErrorEl.classList.add('hidden');
        };

        const makeEmailFromNick = (nick) => `${nick.toLowerCase()}@afc.local`;

        tabLogin.addEventListener('click', () => {
            tabLogin.classList.add('bg-[#3f4d36]', 'text-white');
            tabRegister.classList.remove('bg-[#3f4d36]', 'text-white');
            tabRegister.classList.add('border', 'border-[#3f4d36]', 'text-gray-300');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            hideError();
        });

        tabRegister.addEventListener('click', () => {
            tabRegister.classList.add('bg-[#3f4d36]', 'text-white');
            tabLogin.classList.remove('bg-[#3f4d36]', 'text-white');
            tabLogin.classList.add('border', 'border-[#3f4d36]', 'text-gray-300');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            hideError();
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            const nick = document.getElementById('login-nick').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!nick || !password) return;

            try {
                await signInWithEmailAndPassword(auth, makeEmailFromNick(nick), password);
            } catch (error) {
                showError('Ошибка входа: ' + error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            const nick = document.getElementById('register-nick').value.trim();
            const password = document.getElementById('register-password').value.trim();
            if (!nick || !password) return;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, makeEmailFromNick(nick), password);
                const user = userCredential.user;
                await set(ref(db, `users/${user.uid}`), {
                    nick,
                    admin: false,
                    createdAt: new Date().toISOString()
                });
            } catch (error) {
                showError('Ошибка регистрации: ' + error.message);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        const renderTickets = (tickets, container, options = {}) => {
            if (!tickets.length) {
                container.innerHTML = '<p>Нет тикетов.</p>';
                return;
            }

            const statusStyles = {
                'Новый': 'text-blue-300 border-blue-500/60 bg-blue-500/10',
                'В работе': 'text-yellow-300 border-yellow-500/60 bg-yellow-500/10',
                'Выполнен': 'text-emerald-300 border-emerald-500/60 bg-emerald-500/10',
                'Отклонен': 'text-red-300 border-red-500/60 bg-red-500/10'
            };

            container.innerHTML = tickets.map(ticket => {
                const status = ticket.status || 'Новый';
                const adminControls = options.admin ? `
                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-[auto_1fr] gap-2 items-center">
                        <span class="text-xs uppercase tracking-widest text-gray-500">Статус</span>
                        <select class="admin-status bg-[#0a0b09] border border-[#3f4d36] text-white px-3 py-2 text-sm" data-id="${ticket.id}" data-uid="${ticket.uid}">
                            <option value="Новый" ${status === 'Новый' ? 'selected' : ''}>Новый</option>
                            <option value="В работе" ${status === 'В работе' ? 'selected' : ''}>В работе</option>
                            <option value="Выполнен" ${status === 'Выполнен' ? 'selected' : ''}>Выполнен</option>
                            <option value="Отклонен" ${status === 'Отклонен' ? 'selected' : ''}>Отклонен</option>
                        </select>
                    </div>
                ` : '';

                return `
                    <div class="ticket-card">
                        <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                            <h4 class="ticket-title">${ticket.subject}</h4>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="text-gray-500">${ticket.priority}</span>
                                <span class="ticket-status ${statusStyles[status] || 'text-gray-300 border-gray-600/60 bg-gray-600/10'}">${status}</span>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-2">${ticket.description}</p>
                        <div class="flex flex-wrap gap-3 text-xs text-gray-600">
                            <span>Контакт: ${ticket.contact}</span>
                            <span>Автор: ${ticket.nick}</span>
                            <button class="ml-auto text-[#658451] text-xs uppercase tracking-widest open-chat" data-id="${ticket.id}" data-title="${ticket.subject}" data-owner="${ticket.uid}">
                                Открыть чат
                            </button>
                        </div>
                        ${adminControls}
                    </div>
                `;
            }).join('');
        };

        const loadChats = (ticketId) => {
            if (!ticketId) return;
            const chatRef = ref(db, `ticketChats/${ticketId}`);
            onValue(chatRef, snapshot => {
                const messages = snapshot.val() || {};
                const list = Object.values(messages);
                if (!list.length) {
                    chatMessages.innerHTML = '<p class="text-gray-500 text-sm">Сообщений нет.</p>';
                    return;
                }
                chatMessages.innerHTML = list.map(msg => {
                    const time = new Date(msg.createdAt).toLocaleString('ru-RU');
                    const adminBadge = msg.isAdmin ? '<span class="text-red-300 font-bold">[ADMIN]</span> ' : '';
                    return `
                        <div class="chat-bubble">
                            <div class="text-xs text-gray-500 mb-2">${adminBadge}${msg.author} • ${time}</div>
                            <div class="text-gray-300 text-sm">${msg.text || ''}</div>
                            ${msg.image ? `<img src="${msg.image}" alt="photo" class="mt-2 max-h-48 border border-[#3f4d36]">` : ''}
                        </div>
                    `;
                }).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        };

        const openChatModal = (ticketId, title) => {
            activeTicketId = ticketId;
            chatTicketTitle.textContent = title;
            chatModal.classList.remove('hidden');
            chatModal.classList.add('flex');
            loadChats(activeTicketId);
        };

        const closeChatModal = () => {
            chatModal.classList.add('hidden');
            chatModal.classList.remove('flex');
            activeTicketId = null;
        };

        const attachChatHandlers = () => {
            document.querySelectorAll('.open-chat').forEach(btn => {
                btn.addEventListener('click', () => {
                    openChatModal(btn.dataset.id, btn.dataset.title);
                });
            });
        };

        chatModalClose.addEventListener('click', closeChatModal);
        chatModal.addEventListener('click', (event) => {
            if (event.target === chatModal) {
                closeChatModal();
            }
        });

        const updateStats = (tickets = []) => {
            const active = tickets.filter(ticket => ticket.status === 'Новый').length;
            const progress = tickets.filter(ticket => ticket.status === 'В работе').length;
            const done = tickets.filter(ticket => ticket.status === 'Выполнен').length;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-progress').textContent = progress;
            document.getElementById('stat-done').textContent = done;
        };

        const loadTickets = (uid, isAdmin) => {
            const userTicketsRef = ref(db, `tickets/${uid}`);
            onValue(userTicketsRef, snapshot => {
                const data = snapshot.val() || {};
                const tickets = Object.entries(data).map(([id, ticket]) => ({ id, uid, ...ticket }));
                renderTickets(tickets, userTicketsEl);
                updateStats(tickets);
                attachChatHandlers();
            });

            if (isAdmin) {
                const allTicketsRef = ref(db, 'tickets');
                onValue(allTicketsRef, snapshot => {
                    const data = snapshot.val() || {};
                    const allTickets = [];
                    Object.entries(data).forEach(([userId, userTickets]) => {
                        Object.entries(userTickets || {}).forEach(([id, ticket]) => {
                            allTickets.push({ id, uid: userId, ...ticket });
                        });
                    });
                    renderTickets(allTickets, adminTickets, { admin: true });
                    attachChatHandlers();

                    adminTickets.querySelectorAll('.admin-status').forEach(select => {
                        select.addEventListener('change', async (event) => {
                            const ticketId = event.target.dataset.id;
                            const userId = event.target.dataset.uid;
                            const newStatus = event.target.value;
                            const ticketRef = ref(db, `tickets/${userId}/${ticketId}`);
                            await update(ticketRef, { status: newStatus });
                        });
                    });
                });
            }
        };

        onAuthStateChanged(auth, async user => {
            if (!user) {
                authPanel.classList.remove('hidden');
                dashboard.classList.add('hidden');
                return;
            }

            authPanel.classList.add('hidden');
            dashboard.classList.remove('hidden');

            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val() || { admin: false, nick: 'Боец' };

            userNickEl.textContent = userData.nick || 'Боец';
            userRoleEl.textContent = userData.admin ? 'Администратор' : 'Боец';
            userStatusEl.innerHTML = `<span class="pulse-dot"></span>${userData.admin ? 'Админ онлайн' : 'В сети'}`;
            userStatusEl.className = userData.admin ? 'text-red-300 flex items-center gap-2' : 'text-emerald-300 flex items-center gap-2';

            if (userData.admin) {
                adminPanel.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
            }

            loadTickets(user.uid, userData.admin);
        });

        ticketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (cooldown) return;
            const user = auth.currentUser;
            if (!user) return;

            const subject = document.getElementById('ticket-subject').value.trim();
            const description = document.getElementById('ticket-description').value.trim();
            const priority = document.getElementById('ticket-priority').value;
            const contact = document.getElementById('ticket-contact').value.trim();
            if (!subject || !description || !contact) return;

            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val() || { nick: 'Боец' };

            const ticketRef = push(ref(db, `tickets/${user.uid}`));
            await set(ticketRef, {
                subject,
                description,
                priority,
                contact,
                nick: userData.nick || 'Боец',
                status: 'Новый',
                createdAt: new Date().toISOString()
            });

            ticketForm.reset();
            cooldown = true;
            ticketSubmit.textContent = 'Подождите 10 секунд...';
            setTimeout(() => {
                cooldown = false;
                ticketSubmit.textContent = 'Отправить тикет';
            }, 10000);
        });

        chatSend.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !activeTicketId) return;
            const text = chatInput.value.trim();
            const file = chatFile.files[0];
            let imageData = '';

            if (file) {
                if (file.size > 1024 * 1024) {
                    alert('Файл слишком большой. Максимум 1 МБ.');
                    return;
                }
                imageData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
            }

            if (!text && !imageData) return;

            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val() || { nick: 'Боец', admin: false };

            const messageRef = push(ref(db, `ticketChats/${activeTicketId}`));
            await set(messageRef, {
                author: userData.nick || 'Боец',
                text,
                image: imageData,
                isAdmin: userData.admin === true,
                createdAt: new Date().toISOString()
            });

            chatInput.value = '';
            chatFile.value = '';
        });
    </script>
</body>
</html>
