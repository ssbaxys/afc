<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заказы | AFC - Auxiliary Forces Company</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Teko:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased selection:bg-green-700 selection:text-white">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-[#0a0b09]/90 backdrop-blur-md border-b border-[#3f4d36]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="index.html" class="flex-shrink-0 flex items-center gap-3">
                    <img src="logo.png" alt="AFC Logo" class="h-12 w-auto">
                    <span class="font-bold text-2xl tracking-wider text-gray-100 hidden sm:block font-teko">AFC CLAN</span>
                </a>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="index.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Главная</a>
                        <a href="info.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">О нас</a>
                        <a href="veli.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">VELI</a>
                        <a href="media.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Медиа</a>
                        <a href="work.html" class="hover:text-[#658451] text-gray-300 px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Деятельность</a>
                        <a href="shop.html" class="nav-active text-white px-3 py-2 text-lg font-teko tracking-wide transition-colors uppercase">Заказы</a>
                        <a href="join.html" class="bg-[#3f4d36] hover:bg-[#2d3826] text-white px-4 py-1 text-lg font-teko tracking-wide transition-all border border-[#658451] uppercase">Вступить</a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-btn" class="text-gray-400 hover:text-white focus:outline-none p-2">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu -->
        <div class="hidden md:hidden bg-black/95 border-b border-green-900" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 text-center">
                <a href="index.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">Главная</a>
                <a href="info.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">О нас</a>
                <a href="veli.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">VELI</a>
                <a href="media.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">Медиа</a>
                <a href="work.html" class="text-gray-300 block px-3 py-2 text-xl font-teko uppercase">Деятельность</a>
                <a href="shop.html" class="text-[#658451] block px-3 py-2 text-xl font-teko uppercase">Заказы</a>
                <a href="join.html" class="text-white block px-3 py-2 text-xl font-teko uppercase font-bold">Вступить</a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header pt-20" style="background-image: url('stroi.png');">
        <div class="absolute inset-0 page-header-overlay"></div>
        <div class="relative z-10 text-center px-4 py-20">
            <h1 class="text-5xl md:text-7xl font-bold text-white mb-4 font-teko">ЗАКАЗЫ <span class="text-[#658451]">AFC</span></h1>
            <p class="text-xl text-gray-400">Система заявок и личный кабинет</p>
        </div>
    </section>

    <section class="py-24 bg-[#0a0b09] fade-in-section">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="tactical-border p-8 bg-[#121410] mb-12" id="auth-panel">
                <div class="flex flex-col lg:flex-row gap-10 items-center">
                    <div class="text-center lg:text-left flex-1">
                        <h2 class="text-3xl text-white font-teko mb-3">ДОСТУП В СИСТЕМУ</h2>
                        <p class="text-gray-500">Введите ник и пароль, чтобы создавать заявки и общаться с админами.</p>
                        <p class="text-gray-500 text-sm mt-4">Логин создается по нику. Админы подтверждают заявки и ведут переписку.</p>
                    </div>
                    <div class="flex-1 w-full">
                        <div class="flex gap-3 mb-4">
                            <button id="tab-login" class="px-4 py-2 bg-[#3f4d36] text-white font-teko uppercase tracking-wider">Вход</button>
                            <button id="tab-register" class="px-4 py-2 border border-[#3f4d36] text-gray-300 font-teko uppercase tracking-wider">Регистрация</button>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <input type="text" id="login-nick" placeholder="Ник" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <input type="password" id="login-password" placeholder="Пароль" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <button type="submit" class="w-full bg-[#658451] hover:bg-[#4d663d] text-white px-6 py-3 font-teko text-xl uppercase tracking-wider transition-all">Войти</button>
                        </form>
                        <form id="register-form" class="space-y-4 hidden">
                            <input type="text" id="register-nick" placeholder="Ник" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <input type="password" id="register-password" placeholder="Пароль" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" required>
                            <button type="submit" class="w-full bg-[#3f4d36] hover:bg-[#2d3826] text-white px-6 py-3 font-teko text-xl uppercase tracking-wider transition-all">Создать аккаунт</button>
                        </form>
                        <div class="mt-6 flex items-center gap-3">
                            <span class="flex-1 h-px bg-[#2d3826]"></span>
                            <span class="text-xs uppercase tracking-widest text-gray-500">или</span>
                            <span class="flex-1 h-px bg-[#2d3826]"></span>
                        </div>
                        <button id="google-login" class="mt-4 w-full bg-white/10 hover:bg-white/20 text-white px-6 py-3 font-teko text-xl uppercase tracking-wider transition-all border border-white/20 flex items-center justify-center gap-3">
                            <i class="fab fa-google text-[#ea4335]"></i>
                            Войти через Google
                        </button>
                        <p id="auth-error" class="mt-4 text-sm text-red-300 hidden"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-[1.2fr_0.8fr] gap-10 order-layout hidden" id="dashboard">
                <div class="tactical-border p-8 bg-[#121410] order-panel panel-glow">
                    <div class="flex items-center justify-between flex-wrap gap-4 mb-8">
                        <div>
                            <h2 class="text-3xl text-white font-teko">ЦЕНТР ЗАКАЗОВ</h2>
                            <p class="text-gray-500 text-sm" id="cooldown-hint">Можно создавать несколько тикетов. Между отправками — 10 секунд.</p>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-400" id="user-status">
                            <span class="pulse-dot"></span>
                            Оффлайн
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="stat-chip">
                            <span class="text-xs uppercase tracking-widest text-gray-500">Активные</span>
                            <span class="stat-value" id="stat-active">0</span>
                        </div>
                        <div class="stat-chip">
                            <span class="text-xs uppercase tracking-widest text-gray-500">В работе</span>
                            <span class="stat-value" id="stat-progress">0</span>
                        </div>
                        <div class="stat-chip">
                            <span class="text-xs uppercase tracking-widest text-gray-500">Выполнено</span>
                            <span class="stat-value" id="stat-done">0</span>
                        </div>
                    </div>

                    <form id="ticket-form" class="space-y-5">
                        <div>
                            <label class="text-gray-400 text-sm uppercase tracking-widest">Заголовок</label>
                            <input type="text" id="ticket-subject" class="w-full mt-2 bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Например: Снабжение передовой" required>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm uppercase tracking-widest">Описание</label>
                            <textarea id="ticket-description" rows="5" class="w-full mt-2 bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Опишите задачу, сроки и требования" required></textarea>
                        </div>
                        <button type="submit" id="ticket-submit" class="w-full bg-[#658451] hover:bg-[#4d663d] text-white px-6 py-3 font-teko text-2xl uppercase tracking-wider transition-all border border-transparent hover:border-[#8da378] shadow-[0_0_15px_rgba(101,132,81,0.3)]">
                            Отправить тикет
                        </button>
                    </form>

                    <div class="mt-10 tactical-border p-6 bg-[#0f110e] panel-glow">
                        <h3 class="text-2xl text-white font-teko mb-2">ЧАТ ПО ТИКЕТУ</h3>
                        <p class="text-gray-500 text-sm">Откройте тикет в списке справа — переписка появится в модальном окне.</p>
                    </div>
                </div>

                <div class="space-y-6 order-sidebar">
                    <div class="tactical-border p-6 bg-[#121410]">
                        <h3 class="text-2xl text-white font-teko mb-4">ПРОФИЛЬ</h3>
                        <div class="space-y-3 text-gray-400 text-sm">
                            <p><span class="text-[#658451]">Ник:</span> <span id="user-nick">—</span></p>
                            <p><span class="text-[#658451]">Роль:</span> <span id="user-role">Пользователь</span></p>
                        </div>
                        <button id="logout-btn" class="mt-6 w-full bg-[#3f4d36] hover:bg-[#2d3826] text-white px-4 py-2 font-teko uppercase tracking-wider transition-all">Выйти</button>
                        <button id="link-google" class="mt-3 w-full bg-[#1f2937] hover:bg-[#111827] text-white px-4 py-2 font-teko uppercase tracking-wider transition-all hidden">
                            Привязать Google
                        </button>
                        <button id="admin-toggle" class="mt-3 w-full bg-[#3b2b2b] hover:bg-[#4a3030] text-red-200 px-4 py-2 font-teko uppercase tracking-wider transition-all hidden">
                            Админ режим: выкл
                        </button>
                    </div>

                    <div class="tactical-border p-6 bg-[#121410] panel-glow">
                        <h3 class="text-2xl text-white font-teko mb-4">ПРАВИЛА ПОДАЧИ ТИКЕТОВ</h3>
                        <div id="ticket-rules" class="text-gray-400 text-sm leading-relaxed"></div>
                    </div>

                    <div class="tactical-border p-6 bg-[#121410] panel-glow">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl text-white font-teko">МОИ ТИКЕТЫ</h3>
                            <button id="open-user-tickets" class="text-xs uppercase tracking-widest text-[#658451] hover:text-white transition-colors">Смотреть все</button>
                        </div>
                        <div id="user-tickets" class="space-y-4 text-gray-400 text-sm">
                            <p>Пока нет активных заявок.</p>
                        </div>
                    </div>

                    <div class="tactical-border p-6 bg-[#121410] hidden panel-glow" id="admin-panel">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl text-white font-teko">ПАНЕЛЬ АДМИНА</h3>
                            <button id="open-admin-tickets" class="text-xs uppercase tracking-widest text-red-300 hover:text-white transition-colors">Открыть список</button>
                        </div>
                        <p class="text-gray-500 text-sm mb-4">Доступна только администраторам. Управляйте статусом тикетов и отвечайте в чате.</p>
                        <div class="flex flex-wrap gap-3 text-xs text-gray-500 uppercase tracking-widest mb-4">
                            <span class="px-3 py-1 border border-[#3f4d36]">Live Sync</span>
                            <span class="px-3 py-1 border border-[#3f4d36]">Realtime Database</span>
                        </div>
                        <div class="tactical-border p-4 bg-[#0f110e] mb-5">
                            <h4 class="text-xl text-white font-teko mb-3">ПРАВИЛА ДЛЯ ПОЛЬЗОВАТЕЛЕЙ</h4>
                            <textarea id="admin-rules" rows="5" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Markdown правила"></textarea>
                            <button id="save-rules" class="mt-3 bg-[#3f4d36] hover:bg-[#2d3826] text-white px-4 py-2 font-teko uppercase tracking-wider transition-all">Сохранить правила</button>
                        </div>
                        <div id="admin-tickets" class="space-y-4 text-gray-400 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="chat-modal" class="fixed inset-0 z-[1100] hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-[#0f110e] border border-[#3f4d36] w-[95%] max-w-2xl max-h-[85vh] flex flex-col shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-[#1a1d18]">
                <div>
                    <h3 class="text-2xl text-white font-teko">Чат по тикету</h3>
                    <p class="text-xs uppercase tracking-widest text-gray-500">Тикет: <span id="chat-ticket-title" class="text-[#658451]"></span></p>
                </div>
                <button id="chat-modal-close" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 overflow-y-auto flex-1" id="chat-messages"></div>
            <div class="p-5 border-t border-[#1a1d18] space-y-3">
                <textarea id="chat-input" rows="3" class="w-full bg-[#0a0b09] border border-[#3f4d36] text-white px-4 py-3 focus:outline-none focus:border-[#658451]" placeholder="Сообщение..."></textarea>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                    <label class="attach-btn">
                        <input type="file" id="chat-file" accept="image/*" class="hidden">
                        <i class="fas fa-paperclip"></i>
                        Прикрепить фото
                    </label>
                    <span id="chat-file-name" class="text-xs text-gray-500">Файл не выбран</span>
                    <button id="chat-send" class="ml-auto bg-[#3f4d36] hover:bg-[#2d3826] text-white px-5 py-2 font-teko uppercase tracking-wider transition-all">Отправить</button>
                </div>
                <p class="text-xs text-gray-500">Перетащите изображение в центр экрана, чтобы прикрепить файл (до 1 МБ).</p>
            </div>
        </div>
    </div>

    <div id="drop-overlay" class="drop-overlay">
        <div class="drop-box">
            <i class="fas fa-upload"></i>
            <p>Перетащите изображение сюда</p>
        </div>
    </div>

    <div id="ticket-lightbox">
        <span id="ticket-lightbox-close">&times;</span>
        <img id="ticket-lightbox-img" src="" alt="Увеличенное изображение">
    </div>

    <div id="user-tickets-modal" class="fixed inset-0 z-[1200] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="modal-panel">
            <div class="modal-header">
                <div>
                    <h3 class="text-3xl text-white font-teko">МОИ ТИКЕТЫ</h3>
                    <p class="text-xs text-gray-500 uppercase tracking-widest">поиск, фильтры, история</p>
                </div>
                <button class="modal-close" data-close="user-tickets-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-filters">
                <input type="text" id="user-search" placeholder="Поиск по ключевым словам" class="modal-input">
                <select id="user-status-filter" class="modal-select">
                    <option value="">Все статусы</option>
                    <option value="Новый">Новый</option>
                    <option value="В работе">В работе</option>
                    <option value="Выполнен">Выполнен</option>
                    <option value="Отклонен">Отклонен</option>
                    <option value="Архив">Архив</option>
                </select>
                <input type="date" id="user-date-filter" class="modal-input">
            </div>
            <div class="modal-body" id="user-ticket-list"></div>
        </div>
    </div>

    <div id="admin-tickets-modal" class="fixed inset-0 z-[1200] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="modal-panel">
            <div class="modal-header">
                <div>
                    <h3 class="text-3xl text-white font-teko">ТИКЕТЫ (АДМИН)</h3>
                    <p class="text-xs text-gray-500 uppercase tracking-widest">управление всеми заявками</p>
                </div>
                <button class="modal-close" data-close="admin-tickets-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-filters">
                <input type="text" id="admin-search" placeholder="Поиск по ключевым словам" class="modal-input">
                <select id="admin-status-filter" class="modal-select">
                    <option value="">Все статусы</option>
                    <option value="Новый">Новый</option>
                    <option value="В работе">В работе</option>
                    <option value="Выполнен">Выполнен</option>
                    <option value="Отклонен">Отклонен</option>
                    <option value="Архив">Архив</option>
                </select>
                <input type="date" id="admin-date-filter" class="modal-input">
            </div>
            <div class="modal-body" id="admin-ticket-list"></div>
        </div>
    </div>

    <footer class="bg-[#050505] py-10 border-t border-[#1a1d18]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="Logo" class="h-8 w-auto grayscale opacity-50">
                <span class="text-gray-500 font-teko text-xl tracking-widest">&copy; 2026 AFC CLAN | сайт создан @ssbaxys</span>
            </div>
            <div class="flex space-x-8">
                <a href="https://discord.com/invite/join-afc" class="text-gray-500 hover:text-[#5865F2] transition-colors">
                    <i class="fab fa-discord text-2xl"></i>
                </a>
                <a href="https://www.youtube.com/@wanted2127/videos" class="text-gray-500 hover:text-red-600 transition-colors">
                    <i class="fab fa-youtube text-2xl"></i>
                </a>
            </div>
        </div>
    </footer>

    <div id="update-overlay" class="update-overlay">
        <div class="flex flex-col items-center">
            <div class="update-spinner"></div>
            <div class="update-text">Обновление</div>
        </div>
    </div>

    <script src="app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, linkWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, push, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBRBCKD_86JsJ_x9TRubfSbN4mbj_VIcxI",
          authDomain: "ssbaxys-2945e.firebaseapp.com",
          databaseURL: "https://ssbaxys-2945e-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "ssbaxys-2945e",
          storageBucket: "ssbaxys-2945e.firebasestorage.app",
          messagingSenderId: "952293073742",
          appId: "1:952293073742:web:a66570635496c7a323f41f",
          measurementId: "G-SXZENL1KY8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const authPanel = document.getElementById('auth-panel');
        const dashboard = document.getElementById('dashboard');
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authErrorEl = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const googleLoginBtn = document.getElementById('google-login');
        const linkGoogleBtn = document.getElementById('link-google');

        const userNickEl = document.getElementById('user-nick');
        const userRoleEl = document.getElementById('user-role');
        const userStatusEl = document.getElementById('user-status');
        const adminPanel = document.getElementById('admin-panel');
        const adminToggle = document.getElementById('admin-toggle');
        const userTicketsEl = document.getElementById('user-tickets');
        const adminTickets = document.getElementById('admin-tickets');
        const ticketRules = document.getElementById('ticket-rules');
        const adminRules = document.getElementById('admin-rules');
        const saveRulesBtn = document.getElementById('save-rules');

        const openUserTicketsBtn = document.getElementById('open-user-tickets');
        const openAdminTicketsBtn = document.getElementById('open-admin-tickets');
        const userTicketsModal = document.getElementById('user-tickets-modal');
        const adminTicketsModal = document.getElementById('admin-tickets-modal');
        const userTicketList = document.getElementById('user-ticket-list');
        const adminTicketList = document.getElementById('admin-ticket-list');
        const userSearch = document.getElementById('user-search');
        const userStatusFilter = document.getElementById('user-status-filter');
        const userDateFilter = document.getElementById('user-date-filter');
        const adminSearch = document.getElementById('admin-search');
        const adminStatusFilter = document.getElementById('admin-status-filter');
        const adminDateFilter = document.getElementById('admin-date-filter');

        const chatModal = document.getElementById('chat-modal');
        const chatModalClose = document.getElementById('chat-modal-close');
        const chatTicketTitle = document.getElementById('chat-ticket-title');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatFile = document.getElementById('chat-file');
        const chatFileName = document.getElementById('chat-file-name');
        const chatSend = document.getElementById('chat-send');
        const dropOverlay = document.getElementById('drop-overlay');
        const ticketLightbox = document.getElementById('ticket-lightbox');
        const ticketLightboxImg = document.getElementById('ticket-lightbox-img');
        const ticketLightboxClose = document.getElementById('ticket-lightbox-close');

        const ticketForm = document.getElementById('ticket-form');
        const ticketSubmit = document.getElementById('ticket-submit');

        const googleProvider = new GoogleAuthProvider();
        googleProvider.setCustomParameters({ prompt: 'select_account' });

        let activeTicketId = null;
        let cooldown = false;
        let pendingFile = null;
        let currentNick = 'Пользователь';
        let currentIsAdmin = false;
        let userTicketsCache = [];
        let allTicketsCache = [];
        let chatIndex = {};

        const showError = (message) => {
            authErrorEl.textContent = message;
            authErrorEl.classList.remove('hidden');
        };

        const hideError = () => {
            authErrorEl.textContent = '';
            authErrorEl.classList.add('hidden');
        };

        const makeEmailFromNick = (nick) => `${nick.toLowerCase()}@afc.local`;

        const renderMarkdown = (text = '') => {
            const safe = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            return safe
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        };

        const setRulesContent = (text) => {
            ticketRules.innerHTML = renderMarkdown(text || '—');
        };

        const openModal = (modal) => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeModal = (modal) => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        const updateStatus = () => {
            userStatusEl.innerHTML = `<span class="pulse-dot"></span>${currentIsAdmin ? 'Админ онлайн' : 'В сети'}`;
            userStatusEl.className = currentIsAdmin ? 'text-red-300 flex items-center gap-2' : 'text-emerald-300 flex items-center gap-2';
        };

        tabLogin.addEventListener('click', () => {
            tabLogin.classList.add('bg-[#3f4d36]', 'text-white');
            tabRegister.classList.remove('bg-[#3f4d36]', 'text-white');
            tabRegister.classList.add('border', 'border-[#3f4d36]', 'text-gray-300');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            hideError();
        });

        tabRegister.addEventListener('click', () => {
            tabRegister.classList.add('bg-[#3f4d36]', 'text-white');
            tabLogin.classList.remove('bg-[#3f4d36]', 'text-white');
            tabLogin.classList.add('border', 'border-[#3f4d36]', 'text-gray-300');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            hideError();
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            const nick = document.getElementById('login-nick').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!nick || !password) return;

            try {
                await signInWithEmailAndPassword(auth, makeEmailFromNick(nick), password);
            } catch (error) {
                showError('Ошибка входа: ' + error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            const nick = document.getElementById('register-nick').value.trim();
            const password = document.getElementById('register-password').value.trim();
            if (!nick || !password) return;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, makeEmailFromNick(nick), password);
                const user = userCredential.user;
                await set(ref(db, `users/${user.uid}`), {
                    nick,
                    admin: false,
                    provider: 'local',
                    createdAt: new Date().toISOString(),
                    googleLinked: false
                });
            } catch (error) {
                showError('Ошибка регистрации: ' + error.message);
            }
        });

        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', async () => {
                hideError();
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    const user = result.user;
                    const userRef = ref(db, `users/${user.uid}`);
                    const snapshot = await get(userRef);
                    if (!snapshot.exists()) {
                        await set(userRef, {
                            nick: user.displayName || user.email.split('@')[0],
                            admin: false,
                            provider: 'google',
                            createdAt: new Date().toISOString(),
                            googleLinked: true
                        });
                    }
                } catch (error) {
                    showError('Ошибка входа через Google: ' + error.message);
                }
            });
        }

        if (linkGoogleBtn) {
            linkGoogleBtn.addEventListener('click', async () => {
                hideError();
                try {
                    const user = auth.currentUser;
                    if (!user) return;
                    await linkWithPopup(user, googleProvider);
                    await update(ref(db, `users/${user.uid}`), {
                        googleLinked: true
                    });
                    linkGoogleBtn.textContent = 'Google привязан';
                    linkGoogleBtn.disabled = true;
                } catch (error) {
                    showError('Ошибка привязки Google: ' + error.message);
                }
            });
        }

        const rulesRef = ref(db, 'ticketRules');
        onValue(rulesRef, snapshot => {
            const rulesText = snapshot.val() || 'Указывайте четкий заголовок и подробное описание заказа.';
            setRulesContent(rulesText);
            if (adminRules) {
                adminRules.value = rulesText;
            }
        });

        if (saveRulesBtn) {
            saveRulesBtn.addEventListener('click', async () => {
                const text = adminRules.value.trim();
                await set(rulesRef, text);
            });
        }

        logoutBtn.addEventListener('click', () => signOut(auth));

        const statusStyles = {
            'Новый': 'text-blue-300 border-blue-500/60 bg-blue-500/10',
            'В работе': 'text-yellow-300 border-yellow-500/60 bg-yellow-500/10',
            'Выполнен': 'text-emerald-300 border-emerald-500/60 bg-emerald-500/10',
            'Отклонен': 'text-red-300 border-red-500/60 bg-red-500/10',
            'Архив': 'text-gray-400 border-gray-600/60 bg-gray-600/10'
        };

        const renderTicketCards = (tickets, container, options = {}) => {
            if (!tickets.length) {
                container.innerHTML = '<p>Нет тикетов.</p>';
                return;
            }

            container.innerHTML = tickets.map(ticket => {
                const status = ticket.archived ? 'Архив' : (ticket.status || 'Новый');
                const statusClass = statusStyles[status] || 'text-gray-300 border-gray-600/60 bg-gray-600/10';
                const isArchived = ticket.archived === true;

                const adminControls = options.admin ? `
                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-[auto_1fr] gap-2 items-center">
                        <span class="text-xs uppercase tracking-widest text-gray-500">Статус</span>
                        <select class="admin-status bg-[#0a0b09] border border-[#3f4d36] text-white px-3 py-2 text-sm" data-id="${ticket.id}" data-uid="${ticket.uid}">
                            <option value="Новый" ${ticket.status === 'Новый' ? 'selected' : ''}>Новый</option>
                            <option value="В работе" ${ticket.status === 'В работе' ? 'selected' : ''}>В работе</option>
                            <option value="Выполнен" ${ticket.status === 'Выполнен' ? 'selected' : ''}>Выполнен</option>
                            <option value="Отклонен" ${ticket.status === 'Отклонен' ? 'selected' : ''}>Отклонен</option>
                            <option value="Архив" ${ticket.archived ? 'selected' : ''}>Архив</option>
                        </select>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-2 text-xs">
                        <button class="admin-archive px-3 py-1 border border-[#3f4d36] text-gray-300 hover:text-white ${isArchived ? 'hidden' : ''}" data-id="${ticket.id}" data-uid="${ticket.uid}">Архивировать</button>
                        <button class="admin-unarchive px-3 py-1 border border-emerald-500/50 text-emerald-300 hover:text-white ${isArchived ? '' : 'hidden'}" data-id="${ticket.id}" data-uid="${ticket.uid}">Разархивировать</button>
                        <button class="admin-delete px-3 py-1 border border-red-500/50 text-red-300 hover:text-white" data-id="${ticket.id}" data-uid="${ticket.uid}">Удалить навсегда</button>
                    </div>
                ` : '';

                const userArchive = options.user ? `
                    <div class="flex flex-wrap gap-2 ml-auto">
                        <button class="ticket-archive text-xs uppercase tracking-widest text-gray-500 hover:text-white" data-id="${ticket.id}">Удалить</button>
                    </div>
                ` : '';

                return `
                    <div class="ticket-card">
                        <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                            <h4 class="ticket-title">${ticket.subject}</h4>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="ticket-status ${statusClass}">${status}</span>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-2">${ticket.description}</p>
                        <div class="flex flex-wrap gap-3 text-xs text-gray-600">
                            <span>Автор: ${ticket.nick}</span>
                            <button class="ml-auto text-[#658451] text-xs uppercase tracking-widest open-chat" data-id="${ticket.id}" data-title="${ticket.subject}" data-owner="${ticket.uid}">
                                Открыть тикет
                            </button>
                            ${userArchive}
                        </div>
                        ${adminControls}
                    </div>
                `;
            }).join('');
        };

        const filterTickets = (tickets, filters = {}) => {
            const search = (filters.search || '').toLowerCase().trim();
            const status = filters.status || '';
            const date = filters.date || '';

            return tickets.filter(ticket => {
                const ticketStatus = ticket.archived ? 'Архив' : (ticket.status || 'Новый');
                if (status && ticketStatus !== status) return false;
                if (date) {
                    const ticketDate = new Date(ticket.createdAt).toISOString().slice(0, 10);
                    if (ticketDate !== date) return false;
                }
                if (search) {
                    const messageText = chatIndex[ticket.id] || '';
                    const combined = `${ticket.subject} ${ticket.description} ${ticket.nick} ${messageText}`.toLowerCase();
                    if (!combined.includes(search)) return false;
                }
                return true;
            });
        };

        const renderUserPreview = () => {
            const preview = userTicketsCache.filter(ticket => !ticket.archivedByUser).slice(0, 3);
            renderTicketCards(preview, userTicketsEl, { user: true });
        };

        const renderUserModal = () => {
            const filtered = filterTickets(userTicketsCache.filter(ticket => !ticket.archivedByUser), {
                search: userSearch.value,
                status: userStatusFilter.value,
                date: userDateFilter.value
            });
            renderTicketCards(filtered, userTicketList, { user: true });
            attachTicketActions();
        };

        const renderAdminModal = () => {
            const filtered = filterTickets(allTicketsCache, {
                search: adminSearch.value,
                status: adminStatusFilter.value,
                date: adminDateFilter.value
            });
            renderTicketCards(filtered, adminTicketList, { admin: true });
            attachTicketActions();
        };

        const attachTicketActions = () => {
            document.querySelectorAll('.open-chat').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (userTicketsModal.classList.contains('flex')) {
                        closeModal(userTicketsModal);
                    }
                    if (adminTicketsModal.classList.contains('flex')) {
                        closeModal(adminTicketsModal);
                    }
                    openChatModal(btn.dataset.id, btn.dataset.title);
                });
            });

            document.querySelectorAll('.ticket-archive').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const ticketId = btn.dataset.id;
                    const user = auth.currentUser;
                    if (!user) return;
                    const ticketRef = ref(db, `tickets/${user.uid}/${ticketId}`);
                    await update(ticketRef, { archivedByUser: true, archived: true });
                });
            });

            document.querySelectorAll('.ticket-unarchive').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const ticketId = btn.dataset.id;
                    const user = auth.currentUser;
                    if (!user) return;
                    const ticketRef = ref(db, `tickets/${user.uid}/${ticketId}`);
                    await update(ticketRef, { archivedByUser: false, archived: false });
                });
            });


            document.querySelectorAll('.admin-status').forEach(select => {
                select.addEventListener('change', async (event) => {
                    const ticketId = event.target.dataset.id;
                    const userId = event.target.dataset.uid;
                    const newStatus = event.target.value;
                    const ticketRef = ref(db, `tickets/${userId}/${ticketId}`);
                    if (newStatus === 'Архив') {
                        await update(ticketRef, { archived: true });
                    } else {
                        await update(ticketRef, { status: newStatus, archived: false });
                    }
                });
            });

            document.querySelectorAll('.admin-archive').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (btn.disabled) return;
                    const ticketId = btn.dataset.id;
                    const userId = btn.dataset.uid;
                    const ticketRef = ref(db, `tickets/${userId}/${ticketId}`);
                    await update(ticketRef, { archived: true });
                });
            });

            document.querySelectorAll('.admin-unarchive').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const ticketId = btn.dataset.id;
                    const userId = btn.dataset.uid;
                    const ticketRef = ref(db, `tickets/${userId}/${ticketId}`);
                    await update(ticketRef, { archived: false, archivedByUser: false });
                });
            });

            document.querySelectorAll('.admin-delete').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const ticketId = btn.dataset.id;
                    const userId = btn.dataset.uid;
                    const first = confirm('Удалить тикет навсегда?');
                    if (!first) return;
                    const second = confirm('Точно удалить тикет навсегда?');
                    if (!second) return;
                    await remove(ref(db, `tickets/${userId}/${ticketId}`));
                    await remove(ref(db, `ticketChats/${ticketId}`));
                });
            });
        };

        const loadChatsIndex = () => {
            const chatRef = ref(db, 'ticketChats');
            onValue(chatRef, snapshot => {
                const data = snapshot.val() || {};
                const index = {};
                Object.entries(data).forEach(([ticketId, messages]) => {
                    const text = Object.values(messages || {}).map(msg => `${msg.author} ${msg.text || ''}`).join(' ').toLowerCase();
                    index[ticketId] = text;
                });
                chatIndex = index;
                renderUserModal();
                renderAdminModal();
            });
        };

        const loadTickets = (uid, isAdmin) => {
            const userTicketsRef = ref(db, `tickets/${uid}`);
            onValue(userTicketsRef, snapshot => {
                const data = snapshot.val() || {};
                userTicketsCache = Object.entries(data).map(([id, ticket]) => ({ id, uid, ...ticket }));
                renderUserPreview();
                updateStats(userTicketsCache);
                attachTicketActions();
                renderUserModal();
            });

            if (isAdmin) {
                const allTicketsRef = ref(db, 'tickets');
                onValue(allTicketsRef, snapshot => {
                    const data = snapshot.val() || {};
                    const allTickets = [];
                    Object.entries(data).forEach(([userId, userTickets]) => {
                        Object.entries(userTickets || {}).forEach(([id, ticket]) => {
                            allTickets.push({ id, uid: userId, ...ticket });
                        });
                    });
                    allTicketsCache = allTickets;
                    renderTicketCards(allTicketsCache.slice(0, 4), adminTickets, { admin: true });
                    attachTicketActions();
                    renderAdminModal();
                });
            }
        };

        const updateStats = (tickets = []) => {
            const active = tickets.filter(ticket => ticket.status === 'Новый' && !ticket.archivedByUser && !ticket.archived).length;
            const progress = tickets.filter(ticket => ticket.status === 'В работе' && !ticket.archivedByUser && !ticket.archived).length;
            const done = tickets.filter(ticket => ticket.status === 'Выполнен' && !ticket.archivedByUser && !ticket.archived).length;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-progress').textContent = progress;
            document.getElementById('stat-done').textContent = done;
        };

        const loadChats = (ticketId) => {
            if (!ticketId) return;
            const chatRef = ref(db, `ticketChats/${ticketId}`);
            onValue(chatRef, snapshot => {
                const messages = snapshot.val() || {};
                const list = Object.values(messages);
                if (!list.length) {
                    chatMessages.innerHTML = '<p class="text-gray-500 text-sm">Сообщений нет.</p>';
                    return;
                }
                chatMessages.innerHTML = list.map(msg => {
                    const time = new Date(msg.createdAt).toLocaleString('ru-RU');
                    const adminBadge = msg.isAdmin ? '<span class="text-red-300 font-bold">[ADMIN]</span> ' : '';
                    return `
                        <div class="chat-bubble">
                            <div class="text-xs text-gray-500 mb-2">${adminBadge}${msg.author} • ${time}</div>
                            <div class="text-gray-300 text-sm">${msg.text || ''}</div>
                            ${msg.image ? `<img src="${msg.image}" alt="photo" class="mt-2 max-h-48 border border-[#3f4d36] cursor-pointer ticket-chat-image">` : ''}
                        </div>
                    `;
                }).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;

                document.querySelectorAll('.ticket-chat-image').forEach(img => {
                    img.addEventListener('click', () => {
                        ticketLightboxImg.src = img.src;
                        ticketLightbox.classList.add('active');
                    });
                });
            });
        };

        const openChatModal = (ticketId, title) => {
            activeTicketId = ticketId;
            chatTicketTitle.textContent = title;
            chatModal.classList.remove('hidden');
            chatModal.classList.add('flex');
            loadChats(activeTicketId);
        };

        const closeChatModal = () => {
            chatModal.classList.add('hidden');
            chatModal.classList.remove('flex');
            activeTicketId = null;
            pendingFile = null;
            chatFileName.textContent = 'Файл не выбран';
        };

        chatModalClose.addEventListener('click', closeChatModal);
        chatModal.addEventListener('click', (event) => {
            if (event.target === chatModal) {
                closeChatModal();
            }
        });

        if (ticketLightboxClose) {
            ticketLightboxClose.addEventListener('click', () => {
                ticketLightbox.classList.remove('active');
            });
        }

        if (ticketLightbox) {
            ticketLightbox.addEventListener('click', (event) => {
                if (event.target === ticketLightbox) {
                    ticketLightbox.classList.remove('active');
                }
            });
        }

        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.dataset.close;
                closeModal(document.getElementById(modalId));
            });
        });

        openUserTicketsBtn.addEventListener('click', () => {
            openModal(userTicketsModal);
            renderUserModal();
        });

        openAdminTicketsBtn.addEventListener('click', () => {
            openModal(adminTicketsModal);
            renderAdminModal();
        });

        [userSearch, userStatusFilter, userDateFilter].forEach(input => {
            input.addEventListener('input', renderUserModal);
            input.addEventListener('change', renderUserModal);
        });

        [adminSearch, adminStatusFilter, adminDateFilter].forEach(input => {
            input.addEventListener('input', renderAdminModal);
            input.addEventListener('change', renderAdminModal);
        });

        const handleFileSelect = (file) => {
            if (!file) return;
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Разрешены только изображения: JPG, PNG, WEBP, GIF.');
                return;
            }
            if (file.size > 1024 * 1024) {
                alert('Файл слишком большой. Максимум 1 МБ.');
                return;
            }
            pendingFile = file;
            chatFileName.textContent = file.name;
        };

        chatFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            handleFileSelect(file);
        });

        document.addEventListener('dragover', (event) => {
            if (!chatModal.classList.contains('flex')) return;
            event.preventDefault();
            dropOverlay.classList.add('active');
        });

        document.addEventListener('dragleave', (event) => {
            if (event.relatedTarget === null) {
                dropOverlay.classList.remove('active');
            }
        });

        document.addEventListener('drop', (event) => {
            if (!chatModal.classList.contains('flex')) return;
            event.preventDefault();
            dropOverlay.classList.remove('active');
            const file = event.dataTransfer.files[0];
            handleFileSelect(file);
        });

        ticketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (cooldown) return;
            const user = auth.currentUser;
            if (!user) return;

            const subject = document.getElementById('ticket-subject').value.trim();
            const description = document.getElementById('ticket-description').value.trim();
            if (!subject || !description) return;

            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val() || { nick: currentNick };

            const ticketRef = push(ref(db, `tickets/${user.uid}`));
            await set(ticketRef, {
                subject,
                description,
                nick: userData.nick || currentNick,
                status: 'Новый',
                createdAt: new Date().toISOString(),
                archived: false,
                archivedByUser: false
            });

            ticketForm.reset();
            cooldown = true;
            ticketSubmit.textContent = 'Подождите 10 секунд...';
            setTimeout(() => {
                cooldown = false;
                ticketSubmit.textContent = 'Отправить тикет';
            }, 10000);
        });

        chatSend.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !activeTicketId) return;
            const text = chatInput.value.trim();

            if (!text && !pendingFile) return;

            let imageData = '';
            if (pendingFile) {
                imageData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(pendingFile);
                });
            }

            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val() || { nick: currentNick, admin: false };

            const messageRef = push(ref(db, `ticketChats/${activeTicketId}`));
            await set(messageRef, {
                author: userData.nick || currentNick,
                text,
                image: imageData,
                isAdmin: userData.admin === true,
                createdAt: new Date().toISOString()
            });

            chatInput.value = '';
            chatFile.value = '';
            pendingFile = null;
            chatFileName.textContent = 'Файл не выбран';
        });

        onAuthStateChanged(auth, async user => {
            if (!user) {
                authPanel.classList.remove('hidden');
                dashboard.classList.add('hidden');
                return;
            }

            authPanel.classList.add('hidden');
            dashboard.classList.remove('hidden');

            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val() || { admin: false, nick: null, provider: 'local' };
            const defaultNick = user.displayName || user.email?.split('@')[0] || 'Пользователь';
            const finalNick = userData.nick || defaultNick;

            if (!snapshot.exists()) {
                await set(userRef, {
                    nick: finalNick,
                    admin: false,
                    provider: user.displayName ? 'google' : 'local',
                    createdAt: new Date().toISOString(),
                    googleLinked: user.displayName ? true : false
                });
            } else if (!userData.nick && finalNick) {
                await update(userRef, { nick: finalNick });
            }

            currentNick = finalNick;
            currentIsAdmin = userData.admin === true;

            userNickEl.textContent = finalNick;
            userRoleEl.textContent = userData.admin ? 'Администратор' : 'Пользователь';
            updateStatus();

            if (userData.admin) {
                adminToggle.classList.remove('hidden');
                adminToggle.textContent = adminPanel.classList.contains('hidden') ? 'Админ режим: выкл' : 'Админ режим: вкл';
                adminToggle.addEventListener('click', () => {
                    adminPanel.classList.toggle('hidden');
                    const isOpen = !adminPanel.classList.contains('hidden');
                    adminToggle.textContent = isOpen ? 'Админ режим: вкл' : 'Админ режим: выкл';
                    if (isOpen) {
                        loadTickets(user.uid, true);
                    }
                });
            } else {
                adminPanel.classList.add('hidden');
            }

            if (userData.provider === 'local') {
                linkGoogleBtn.classList.remove('hidden');
                if (userData.googleLinked) {
                    linkGoogleBtn.textContent = 'Google привязан';
                    linkGoogleBtn.disabled = true;
                } else {
                    linkGoogleBtn.textContent = 'Привязать Google';
                    linkGoogleBtn.disabled = false;
                }
            } else {
                linkGoogleBtn.classList.add('hidden');
            }

            loadTickets(user.uid, userData.admin);
            loadChatsIndex();
        });
    </script>
</body>
</html>
